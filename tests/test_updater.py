import shutil

import pytest

import hathi_checksum.update_report

CHECKSUM_FILE_TEXT = """dd2cded075d7267ff660a947fd46ac0f *00000001.jp2
78036918331dc34fc373bd6f70dbdb91 *00000001.txt
7a101e5b45267479397c26c7bb05e194 *00000002.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000002.txt
8e7f9854729291308544dd3d93cd1826 *00000003.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000003.txt
0140143afd6973a33305110b93921c8c *00000004.jp2
61422a3bee4a9b640275bce101782fe1 *00000004.txt
219d01fbc5aa843cd10153054a9df63f *00000005.jp2
2abfacb074c11a4217c067a95139fa2f *00000005.txt
efa40ca77645db10565a0620bd6da06b *00000006.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000006.txt
d47a3e99798a09adb036c573fdfb92a9 *00000007.jp2
99a66eac8c21d0b1bfb8128fad3c7427 *00000007.txt
866c96d2566dfdb4cd4ac838e8408dee *00000008.jp2
1f67e59efa3f9a4b15262273e957bf79 *00000008.txt
24636e38f7d0e636ff790da0ecfe1670 *00000009.jp2
82495f97ba86e2cddb8caf7a40cbd18c *00000009.txt
d55db38e73eac5c8d7151c0abbb4b58c *00000010.jp2
fab33fa2d6227106c372557f16a5ca5c *00000010.txt
093130f61fa9035b5c0e3a79124d1c30 *00000011.jp2
63dabccb910f7c7740a5966472ba7a93 *00000011.txt
b29763bd29dff47a63a79e7b12928b08 *00000012.jp2
b23c8718b1ed2c725f78fc73c4d7afa2 *00000012.txt
9cc1d2390c0fa0f1bc30cce377a41a02 *00000013.jp2
051a3a9ec39d3ad829b5b158e0570d34 *00000013.txt
f720296330901c7a0c4e96f7148f8eb7 *00000014.jp2
6f57a24375d6a0444e002c00512216eb *00000014.txt
8199085d3f5215733333aa1b987907f0 *00000015.jp2
a0d6305df17ba49b19f789b59303715e *00000015.txt
375acc527098dc1c3c4926e1746992a1 *00000016.jp2
94e41dfb18429eb7ce8a0dd3952a3ffe *00000016.txt
407d5e9dc3f0b4b01c877f8cebb3290e *00000017.jp2
b7c46bbb54e9e573b02d668bb24c03d5 *00000017.txt
3bb5484ddd92ff276cec15a28e4d22fd *00000018.jp2
9a9968658132c74984b269d9e5886e66 *00000018.txt
433dfcfb14dbffbb7654481975c695cd *00000019.jp2
e9ac43c7d21b9e44c09e3b8f24070b90 *00000019.txt
11c08a70f0ac41deb1da740be912b48f *00000020.jp2
1ce49d486e1ba0f09a763e707fccf3ab *00000020.txt
43de67d96b0c5cc4590e80c82ea6113c *00000021.jp2
26cd515aa2f29bdfa99838d9b4a2bd4d *00000021.txt
ba353618dc26de008e45a4d5095ea620 *00000022.jp2
35205a0f8ca97fc62342b7bdc7a5b351 *00000022.txt
f26749b1b08ed87fa607ff40977189b5 *00000023.jp2
2e54c6fb5ebb076a64c82c5ec795de51 *00000023.txt
04b694b55bc839a1face6670d4bffb54 *00000024.jp2
9f409d8c37d21734ead4803411eef45d *00000024.txt
2fbb932b1566214efd6b51e10b86d244 *00000025.jp2
b5a520aef967ba4d384e2a513e671571 *00000025.txt
bd2ab9c06d4bc9f219c799fc52ca2d33 *00000026.jp2
7e7dac20195997f17bdacbe31f4f55a6 *00000026.txt
8b24cd4a1405c28fd78a5d669403c82a *00000027.jp2
577203fb28fbe2be2039b345859ba1fb *00000027.txt
14388c05d960e0260471a2de61593788 *00000028.jp2
97e790761825cc32be7bd93f557a28b3 *00000028.txt
35a4fb8519d38edb87e1d06d07cc7bb8 *00000029.jp2
0be9942b53d81f52af425d6cdd0914a2 *00000029.txt
9c24dcfc01321a293f0ee085686d2b07 *00000030.jp2
c65384ea88c16c216a7da1815fd14b0e *00000030.txt
f2825bb611f7aef0eb3f24da0e5df668 *00000031.jp2
8c75505a371a7d602475080aa3ca237c *00000031.txt
d4db4ab2d3c6c4ed8b064fd173ce0d6e *00000032.jp2
fcd97ea4345fc076d9239a2c3c496bb7 *00000032.txt
faf4525ae45d15619939cc34892c48a4 *00000033.jp2
8e735275098522c797e9c253ada68917 *00000033.txt
84cbcfa656ed2b71fe0e641ec17f989b *00000034.jp2
904b97588d4acdb4570b65d250b0bb9c *00000034.txt
5907f3513fac1806d8c9234899764643 *00000035.jp2
45a2b59718d07e490628492f8e111236 *00000035.txt
b85b7b0568de296a5d7847096b11e2ed *00000036.jp2
d5ae1fc26d6222905cd1f460e1942b4d *00000036.txt
4ab8fe17d8a9eb51245017f246d9e4d9 *00000037.jp2
46af36cae5d0c8a791c3e53195e4d1de *00000037.txt
60536a1d656da610e939207428bed4f7 *00000038.jp2
462ed1b2fe4a0e7ec59a881c0c031313 *00000038.txt
5a14e4012bfedd4d2e81ab0e94fcf818 *00000039.jp2
e23deed194ac5d32af08812f3894fdf6 *00000039.txt
b495f3e82591d6f9213e12ea92226553 *00000040.jp2
e8b06d36605af00c2102e3646e0b7875 *00000040.txt
7eb8cc86027cfc839e2cf3104b7092b9 *00000041.jp2
e999736993130bf30f51d2d888bb709f *00000041.txt
2ce715b0cda12d15aaa21e388f902735 *00000042.jp2
5f06b65cfae45ac1e4f0e8641f09c565 *00000042.txt
23f6f8cc535eb43da95fe728f2a7c14c *00000043.jp2
a4f699487d178eef8d638897aa915587 *00000043.txt
f90b531089dd4d6add2ef141ea6a0f01 *00000044.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000044.txt
0c61aae976e712ba4b176798bf811791 *00000045.jp2
152de0dfefaa475ffca1d2ac34c0a45d *00000045.txt
ebbf2d7e2d9500891f1183d7edb086d9 *00000046.jp2
a05edc2901111f061fb1f22f6f25d008 *00000046.txt
28b6d1eaa40b1f4f7301ae0c37aeee21 *00000047.jp2
ac534085bea5ff891e77d6243ed9d711 *00000047.txt
bbcc5ef83e79718065c0263bbbe480ea *00000048.jp2
1fab868abef43cb8d693f5e9e7373860 *00000048.txt
2e2cd27b971a6a7db5bd2b724c8e76f8 *00000049.jp2
e61e471d58d1cf70b72896f6530e4b90 *00000049.txt
94a47f36f8d295bdd34b57a30ed29f88 *00000050.jp2
ce5bd2377907d88884ff41fd91bdd6cf *00000050.txt
1c3d137e65b813440533b681545c082a *00000051.jp2
695dff352215dcaf8462faa961ac011f *00000051.txt
11e7be4c511f3c54d811f3c56f2e97f0 *00000052.jp2
db349f19a30f8b1b17d7f302095a9097 *00000052.txt
2c95942145b0c2ee614bb8e36359d4a0 *00000053.jp2
bb044c90551510a3298f7beb2b127f6a *00000053.txt
82d6a64ff0f4e6088ff2b48c124d15ff *00000054.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000054.txt
91db8d1d1c532f799319372f8cdac92c *00000055.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000055.txt
4542d73c76ab75f1cb0dca0d7d96467f *00000056.jp2
ecaa88f7fa0bf610a5a26cf545dcd3aa *00000056.txt
0538bb97e79b4168a726c29db3853ac3 *marc.xml
6a12336450d1c4703c2a0ab98de8c8fe *meta.yml
"""


@pytest.fixture(scope="session")
def md5_file(tmpdir_factory):
    root_dir = tmpdir_factory.mktemp("temp_package", numbered=False)
    fn = root_dir.join("checksum.md5")
    with open(str(fn), "w") as f:
        f.write(CHECKSUM_FILE_TEXT)
    yield str(fn)
    shutil.rmtree(root_dir)


def test_update_checksum(md5_file):
    hathi_checksum.update_report.update_hash_value(md5_file, "meta.yml", new_hash="00000000000000000000000000000000")
    lines = []
    with open(md5_file) as f:
        for l in f:
            lines.append(l.strip())

    assert lines[-1] == "00000000000000000000000000000000 *meta.yml"
